from typing import Any, Dict, List


LEVEL_A_CONTENT = [
    "3512100030",
    "2166100024",
    "2166100025",
    "3512100023",
    "2166100026",
    "2166100027",
]
LEVEL_A_AUTOMATION = [
    "3512100030",
    "4132300019",
    "2421200016",
    "3512100023",
]
LEVEL_B_AUTOMATION = [
    "2421200016",
    "2511200005",
    "2511200020",
    "2511200003",
]
LEVEL_B_TECHNICAL = [
    "2511200021",
    "2511200005",
    "2511200020",
]
LEVEL_C_TECHNICAL = [
    "2511200021",
    "2511200022",
    "2511200005",
    "2511200004",
]


def recommend_courses(
    training_level: str,
    track: str,
    weekly_time: Any = None,
    goal: Any = None,
) -> Dict[str, Any]:
    """Recommend TVTO course codes for the given level and track."""
    level = str(training_level).upper()
    track = str(track or "").lower()
    goal = str(goal or "").strip()

    if level == "A":
        if track == "content":
            recommended = _content_first(LEVEL_A_CONTENT, goal)
            reason = "???? ???? ????? ??? ????? ????? ? ???????? ???? ????? ???????."
        else:
            recommended = LEVEL_A_AUTOMATION
            reason = "???? ???? ????? ??? ???????? ??????? ? ????????? ???? ????? ???????."
    elif level == "B":
        if track == "automation":
            recommended = LEVEL_B_AUTOMATION
            reason = "???? ??? ????????? ????? ????????? ? ?? ????? ??????? ??????."
        elif track == "technical":
            recommended = LEVEL_B_TECHNICAL
            reason = "???? ???? ???? ??????? ?????? ? ?? ????? ????? ???."
        else:
            recommended = _content_first(LEVEL_A_CONTENT, goal) + ["2421200016"]
            reason = "???? ???? ?????? ??????? ?? ?????? ???????."
    else:
        if track == "technical":
            recommended = LEVEL_C_TECHNICAL
            reason = "???? ???? ?????? ???? ? ??????? ????? ????? ???."
        elif track == "automation":
            recommended = LEVEL_B_AUTOMATION + ["2511200020"]
            reason = "???? ???? ????????? ???????? ????? ????? ???? ???."
        else:
            recommended = _content_first(LEVEL_A_CONTENT, goal) + ["2511200003"]
            reason = "???? ???? ?????? ???????? ? ?????? AI ??? ???."

    low_time = _is_low_time(weekly_time)
    if low_time:
        recommended = recommended[:3]
        reason = "?? ???? ?? ???? ??? ??? ???? ???? ? ???????? ????? ???????."

    blocked = _blocked_by_level(level, track, low_time)

    reason_fa = [reason]
    if low_time:
        reason_fa.append("?? ???? ?????? ???? ??? ?????????????? ??? ?????.")

    return {
        "recommended_courses": _dedupe(recommended),
        "blocked_courses": _dedupe(blocked),
        "reason_fa": reason_fa,
    }


def _blocked_by_level(level: str, track: str, low_time: bool) -> List[str]:
    if level == "A":
        return [
            "2511200021",
            "2511200011",
            "2511200022",
            "2511200020",
            "2511200004",
        ]

    if level == "B":
        if track == "technical" and not low_time:
            return []
        return ["2511200022", "2511200004"]

    return []


def _content_first(courses: List[str], goal: str) -> List[str]:
    if goal != "????? ????":
        return courses
    priority = ["2166100024", "2166100025", "3512100023", "3512100030"]
    ordered = [code for code in priority if code in courses]
    ordered.extend([code for code in courses if code not in ordered])
    return ordered


def _is_low_time(weekly_time: Any) -> bool:
    if weekly_time is None:
        return False
    if isinstance(weekly_time, (int, float)):
        return float(weekly_time) <= 2
    value = str(weekly_time).strip()
    if not value:
        return False
    normalized = _normalize_digits(value)
    normalized = normalized.replace(" ", "").replace("?", "-").replace("?", "-")
    return "1-2" in normalized


def _normalize_digits(text: str) -> str:
    mapping = str.maketrans("????????????????????", "01234567890123456789")
    return text.translate(mapping)


def _dedupe(values: List[str]) -> List[str]:
    seen = set()
    output = []
    for value in values:
        if value in seen:
            continue
        seen.add(value)
        output.append(str(value))
    return output
